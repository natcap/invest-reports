import time
import unittest
import lxml.html


from natcap.invest.coastal_vulnerability import MODEL_SPEC
import pandas

from invest_reports import jinja_env


class CoastalVulnerabilityReportTests(unittest.TestCase):
    """Unit tests for Coastal Vulnerability template."""

    def test_template_render(self):
        """Test render the coastal vulnerability template."""
        template = jinja_env.get_template('coastal_vulnerability.html')

        vegalite_json = '{}'
        model_name = MODEL_SPEC.model_title
        model_description = 'model description'
        args_dict = {}
        exposure_map_json = vegalite_json
        habitat_map_json = vegalite_json
        habitat_params_df = pandas.DataFrame()
        habitat_table_description = 'table description'
        exposure_histogram_json = vegalite_json
        facetted_histograms_json = vegalite_json
        rank_vars_figure_json = vegalite_json
        wave_energy_map_json = vegalite_json
        html = template.render(
            report_script=__file__,
            timestamp=time.strftime('%Y-%m-%d %H:%M'),
            page_title=f'InVEST Results: {model_name}',
            model_id=MODEL_SPEC.model_id,
            model_name=model_name,
            model_description=model_description,
            userguide_page=MODEL_SPEC.userguide,
            args_dict=args_dict,
            exposure_map_json=exposure_map_json,
            habitat_map_json=habitat_map_json,
            habitat_params_table=habitat_params_df.to_html(),
            habitat_table_description=habitat_table_description,
            exposure_histogram_json=exposure_histogram_json,
            facetted_histograms_json=facetted_histograms_json,
            rank_vars_figure_json=rank_vars_figure_json,
            wave_energy_map_json=wave_energy_map_json,
            model_spec_outputs=MODEL_SPEC.outputs,
            accordions_open_on_load=True,
        )

        root = lxml.html.document_fromstring(html)
        sections = root.findall('.//section')
        self.assertEqual(len(sections), 6)
