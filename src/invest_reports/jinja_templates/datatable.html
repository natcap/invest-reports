<!--
This macro displays an html table as an interactive datatable.
It supports filtering rows by the value of a single column.
And it includes the 'colvis' extension for showing/hiding columns.

`html_table` - the html table to display. It must already have id=table_id
`table_id` - the element id of the table.
`filter_column` - the column name that will support filtering rows.
                  Values of this column will appear in a dropdown menu.
-->
{% macro datatable(html_table, table_id, filter_column) -%}
  <div id="value-select-container">
      <label for="value-select">Filter by {{ filter_column }}: </label>
  </div>
  <div>
      {{html_table | safe}}
  </div>
  <script type="text/javascript">
    window.addEventListener('DOMContentLoaded', function () {
      new DataTable('#{{ table_id }}', {
        paging: false,
        layout: {
          topStart: null,
          topEnd: null,
          bottomStart: {
            buttons: ['colvis']
          },
          bottomEnd: null
        },
        autoWidth: false,
        columnDefs: [
          {
            targets: '_all',
            render: function (data, type, row, meta) {
              const number = parseFloat(data);
              let string = data
              if (!isNaN(number)) {
                  string = number.toLocaleString(
                      undefined,
                      {
                          minimumFractionDigits: 0,
                          maximumFractionDigits: 2
                      });
              }
              return string;
            }
          }
        ],
        initComplete: function () {
          this.api()
            .columns('{{ filter_column }}:title')
            .every(function () {
              let column = this;

              let select = document.createElement('select');
              select.setAttribute('id', 'value-select');
              select.add(new Option(''));
              document.getElementById('value-select-container').append(select);

              select.addEventListener('change', function () {
                column
                  .search(select.value, {exact: true})
                  .draw();
              });

              column
                .data()
                .unique()
                .sort()
                .each(function (d, j) {
                  select.add(new Option(d));
                });
            });
          }
      });
    });
  </script>
{%- endmacro %}
