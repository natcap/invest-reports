import json
import logging
import os
import sys

from invest_reports import sdr_ndr_utils
from invest_reports.jinja_report_generators import sdr_ndr_report_generator
from invest_reports.utils import RasterPlotConfig, RasterPlotConfigGroup

LOGGER = logging.getLogger(__name__)

INPUT_RASTER_PLOT_TUPLES = [
    ('dem_path', 'continuous'),
    ('runoff_proxy_path', 'continuous'),
    ('lulc_path', 'nominal')
]

OUTPUT_RASTER_PLOT_TUPLES = {
    'calc_n': [
        ('n_surface_export', 'continuous', 'linear'),
        ('n_subsurface_export', 'continuous', 'linear'),
        ('n_total_export', 'continuous', 'linear'),
    ],
    'calc_p': [
        ('p_surface_export', 'continuous', 'linear')
    ],
}

INTERMEDIATE_OUTPUT_RASTER_PLOT_TUPLES = [
    ('masked_dem', 'continuous'),
    ('what_drains_to_stream', 'binary'),
]


def _build_output_raster_plot_configs(args_dict, file_registry):
    output_raster_plot_tuples = []
    if args_dict['calc_n']:
        output_raster_plot_tuples.extend(
            OUTPUT_RASTER_PLOT_TUPLES['calc_n'])
    if args_dict['calc_p']:
        output_raster_plot_tuples.extend(
            OUTPUT_RASTER_PLOT_TUPLES['calc_p'])
    return [
        RasterPlotConfig(file_registry[output_id], datatype, transform)
        for (output_id, datatype, transform) in output_raster_plot_tuples]


def report(file_registry, args_dict, model_spec, target_html_filepath):
    """Generate an HTML summary of model results.

    Args:
        file_registry (dict): The ``natcap.invest.FileRegistry.registry``
            that was returned by the model's ``execute`` method.
        args_dict (dict): The arguments that were passed to the model's
            ``execute`` method.
        model_spec (natcap.invest.spec.ModelSpec): the model's ``MODEL_SPEC``.
        target_html_filepath (str): path to an HTML file to be generated by
            this function.

    Returns:
        ``None``
    """

    input_raster_plot_configs = sdr_ndr_utils.build_input_raster_plot_configs(
        args_dict, INPUT_RASTER_PLOT_TUPLES)

    output_raster_plot_configs = _build_output_raster_plot_configs(
        args_dict, file_registry)

    intermediate_raster_plot_configs = sdr_ndr_utils.build_intermediate_output_raster_plot_configs(
        args_dict, file_registry, INTERMEDIATE_OUTPUT_RASTER_PLOT_TUPLES)

    raster_plot_configs = RasterPlotConfigGroup(
        input_raster_plot_configs,
        output_raster_plot_configs,
        intermediate_raster_plot_configs)

    sdr_ndr_report_generator.report(
        file_registry, args_dict, model_spec, target_html_filepath,
        raster_plot_configs)

